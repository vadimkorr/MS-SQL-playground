# Transactions & Isolation levels

## Table of contents
* [Concurrency models](#concurrency-models)
* [Transactions](#transactions)
* [Properties of transactions](#properties-of-transactions)
* [Transact SQL statements and transactions](#transact-sql-statements-and-transactions)
* [Transaction log](#transaction-log)
* [Isolation levels](#isolation-levels)
* [Isolation levels of Database Engine](#isolation-levels-of-database-engine)
* [Setting and editing isolation levels](#setting-and-editing-isolation-levels)
* [Row versioning](#row-versioning)

## **Concurrency models**
Database Engine поддерживает две разные модели одновременного крнкурентного доступа:
* пессимистический - для предотвращения одновременного доступа к данным, которые используются другим процессом, применяются блокировки. Предполагается, что несколькими процессами в любое время может возникнуть конфликт. 
* оптимистический - основан на предположении маловероятности изменения данных одной транзакцией одновременно с другой. Database Engine применяет данную модель, при котором сохраняются старые версии строк, и любой процесс при чтении данных использует ту версию строки, которая была активной, когда он начал чтение. 

## **Transactions**
Задает последовательность инструкций, применяемую программистами БД для объединения в один пакет операций чтения и записи.

Два типа транзакций:
* неявная - задает любую отдельную инструкцию `INSERT`, `UPDATE`, `DELETE` как единицу транзакции
* явная - группа инструкций, начало и конец которой обозначаются иструкциями `BEGIN TRANSACTION`, `COMMIT`, `ROLLBACK`.

```sql
BEGIN TRANSACTION 
UPDATE employee
    SET emp_no=39831
        WHERE emp_no=10102
        IF (@@error <> 0)
            ROLLBACK
UPDATE works_on
    SET emp_no=39831
    WHERE emp_no=10102
    IF (@@error <> 0)
        ROLLBACK
COMMIT
```

## **Properties of transactions**
Свойства транзакций, свойства ACID 
* Atomicity (Атомарность) - обеспечивает неделимость набора инструкций, который модифицирует данные в БД и является частью транзакции. 
* Consistency (Согласованность) - обеспечивает, что БД не будет содержать несогласованных данных. (Перевод БД из одного согласованного сосятояния в другое).
* Isolation (Изолированность) - отделяет все параллельные транзакции друг от друга. 
* Durability (Долговечность) - обеспечивает сохраняемость данных. Эффект транзакции должен оставаться действенным даже в случае системной ошибки (иначе - откат транзакции).

## **Transact SQL statements and transactions**
* `BEGIN TRANSACTION` - запускает транзакцию 
* `BEGIN DISTRIBUTED TRANSACTION` - запускает распределенную транзакцию, которая управляется MS Distributed Transaction Coordinator (MS DTC). Это транзакция, которая используется на нескольких БД и на нескольких серверах. Координатором является сервер, запустивший иснтрукцию. 
* `COMMIT [WORK]` - успешно завершает транзакцию.
* `ROLLBACK [WORK]` - сообщает о неуспешном выполненнии транзакции. 
* `SAVE TRANSACTION` - устанавливает точку сохранения внутри транзакции. 
* `SET IMPLICIT_TRANSACTION` - для разрешения неявных транзакций необходимо присвоить значение `ON`.

```sql
BEGIN TRANSACTION;
INSERT INTO department (dept_no, dept_name)
    VALUES ('d4', 'Sales');
SAVE TRANSACTION a;

INSERT INTO department (dept_no, dept_name)
    VALUES ('d5', 'Research');
SAVE TRANSACTION b;

INSERT INTO department (dept_no, dept_name)
    VALUES ('d6', 'Management');
ROLLBACK TRANSACTION b;

INSERT INTO department (dept_no, dept_name)
    VALUES ('d7', 'Support');
ROLLBACK TRANSACTION a;
COMMIT TRANSACTION;
```


## **Transaction log**

Компонент Database Engine сохраняет все запист, в особенности значения до и после транзакции, в одном или более файлов, который называются журналами транзакций.

## **Isolation levels**
Уровень изоляции задает степень защищенности выбираемых транзакцией данных от возможности изменения другими транзакциями. 

Если блокировка не используется и транзакции не изолированы друг от друга, то могут возникнуть следующие проблемы:
* потеря обновлений  - несколько транзакций одновременно могут считывать и обновлять одни и те же данные. При этом теряются все обновления данных, за исключением обновлений, выполненных последней транзакцией. 
* грязное чтение
* неповторяемое чтение - когда один процесс считывает данные несколько раз, а другой процесс изменяет эти данные между двумя операциями чтения первого процесса. В таком случае значения двух чтений будут разными. 
* фантомы - считывание разного количества строк при каждом чтении. Дополнительные строки называются фантомами и вставляются другими транзакциями. 

## **Isolation levels of Database Engine**
* `READ UNCOMMITTED` (пессим.) - самая простая форма изоляции, вообще не изолирует операции чтения других транзакций. Когда транзакция выбирает строку при этом уровне изоляции, она не задает никаких блокировок и не признает никаких существующих блокировок. 
* `READ COMMITTED` (пессим. + оптим.) - пессим.: выполняет проверку только на наличие монопольной блокировки для данной строки. Если такая блокировка отсутствует, транзакция извлекает строку. 
* `READ COMMITTED SNAPSHOT` (оптим.) - облегченный вариант `READ COMMITTED` - это изоляция на уровне инструкций, что означает, что любая другая транзакция будет читать зафиксированные значения в том виде, в каком они существовали на момент начала этой инструкции. 
* `REPEATABLE READ` (пессим.) - устанавливает разделяемые блокировки на все считываемые данные и удерживает эти блокировки до тех пор, пока транзакция не будет подтверждена или отменена. Этот уровень не препятствует другим инструкциям вставлять новые строки, которые включаются в последующие операции чтения, вследствие чего могут появляться фантомы.
* `SERIALIZABLE` (пессим.) - самый строгий. Не допускает появления всех четырех проблем параллельного одновременного конкурентного доступа. Устанавливает блокировку на всю область дданных, считываемых соответсвующей транзакцией. 
* `SNAPSHOT` (оптим.) - на уровне транзакций, что означает, что любая другая транзакция будет читать подтвержденные значения в том виде, в каком они существовали непосредственно перед началом выполнения транзакции этого уровня изоляции.

`READ COMMITTED SNAPSHOT` | `SNAPSHOT`
---|---
Позволяет другим транзакциям изменять данные до того, как будет завершена транзакция типа управления версиями строк | Возможны кофликты обновлений, когда процесс работает с одними и теми же данными во время выполнения транзакции и не является заблокированным. 

Чем выше уровень изоляции, тем меньше степень одновременного конкурентного доступа.


## **Setting and editing isolation levels**
Уровень изоляции можно установить, используя следующие средства:
* параметр `TRANSACTION ISOLATION LEVEL` иструкции `SET`
* подсказки уровня транзакции

## **Row versioning**
Database Engine поддерживает механизм управления оптимистической параллельной работы, который основан на управлении версиями строк. При модифицировании данных с использованием этого механизма, для всех выполняемых в БД модификаций данных создаются и поддерживаются логические копии данных. При каждой модификации строки система БД сохраняет в системной БД `tempdb` исходный вид записи ранее зафиксированной строки. 