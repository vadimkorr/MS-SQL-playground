# Indices

## Table of contents

## **Introduction**
Используются для обеспечения быстрого доступа к реляционным данным. Индекс - отдельная физическая структура данных, которая позволяет получать быстрый доступ к одной или нескольким строкам данных. 

Индексы сохраняются в дополнительных структурах БД, называющихся страницами индексов.

Для каждой индексируемой строки имеется элемент индекса (index entry), который сохраняется на странице индексов.

Индексы компонента Database Engine создаются, используя структуру данных сбалансированного дерева B+. B+ дерево имеет древовидную структуру, в которой все самые нижние узлы (листья) находятся на расстоянии одинаковогоколичества уровней от вершины дерева. 

## **Clustered indices**
Определяет физический порядок данных в таблице. Можно созхдавать лишь один кластеризованный индекс. Поиск с использованием кластеризованного индекса выполняется от корневого узла B+ дерева по направлению к листьям, которые связаны между собой в двунаправленный связанный сптсок, называющийся цепочеой страниц.

## **Nonclustered indices**
* Не изменяет физическое упорядочивание строк таблицы.
* Страницы листьев некластеризованного индекса состоят из ключей индекса и закладок.

Закладка в некластеризованном индексе указывает, где находится строка, соответствующая ключу индекса.

поиск данных с использованием некластеризованного индекса можно выполнять двумя способами:
* куча - прохождение при поиске по структуре некластеризованного индекса, после чего строка извлекается, используя идентификатор строки. (куча - таблица без кластеризованного индекса)
* кластеризованная таблица - прохождение при поиске по структуре некластеризованного индекса, после чего следует прохождение по кластеризрованному индексу.

## **Creating Indices**
```sql
USE sample;
CREATE INDEX i_empno ON employee (emp_no);
```

```sql
CREATE UNIQUE INDEX i_empno_prno
ON works_on (emp_no, project_no)
WITH FILLFACTOR = 80;
```

## **Obtaining index fragmentation information**
В течение жизненного цикла индекса он может подвергнуться фрагментации, вследствие чего процесс хранения данных в страницах индекса станет неэффективным. Два типа фрагментации индекса:
* внутренняя - поределяет объем данных, хранящихся в каждой странице
* внешняя - возникает при нарушении логического порядка страниц

Для получения информации о ынутренней фрвгментации индекса применяется динамическое административное представление (ДАП), называемое `sys.dm_db_index_physical_stats`.

```sql
DECLARE @db_id INT;
DECLARE @tab_id INT;
DECLARE @ind_id INT;

SET @db_id = DB_ID('sample');
SET @tab_id = OBJECT_ID('employee');

SELECT avg_fragmentation_in_percent, avg_page_space_used_in_percent
FROM sys.dm_db_index_physical_stats (@db_id, @tab_id, NULL, NULL, NULL)
```

## **Editing index information**
Информацию индекса можно редактировать с помощью следующих систменых средств:
* представления каталога `sys.indexes`
* представления каталога `sys.index_columns`
* системной процедуры `sp_helpindex`
* функции свойств `OBJECTPROPERTY`
* среды управления Management Studio сервера SQL Server
* динаммического админстративного представления `sys.dm_db_index_physical_stats`
* ДАП `sys.dm_db_missing_index_details`